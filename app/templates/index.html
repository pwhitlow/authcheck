{% extends "base.html" %}

{% block content %}
<div id="app">
    <div id="alert-container"></div>

    <!-- Tabs for different modes -->
    <div style="margin-bottom: 30px; border-bottom: 2px solid #ddd;">
        <button
            id="tab-compare"
            class="tab-button active"
            onclick="switchTab('compare')"
            style="
                background: none;
                border: none;
                padding: 12px 24px;
                font-size: 16px;
                cursor: pointer;
                border-bottom: 3px solid #667eea;
                color: #333;
                margin-right: 20px;
                font-weight: 500;
            "
        >
            üìä Compare All Users
        </button>
        <button
            id="tab-verify"
            class="tab-button"
            onclick="switchTab('verify')"
            style="
                background: none;
                border: none;
                padding: 12px 24px;
                font-size: 16px;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                color: #999;
                margin-right: 20px;
                font-weight: 500;
            "
        >
            üîç Verify Specific Users
        </button>
    </div>

    <!-- Compare All Users Tab -->
    <div id="tab-content-compare" class="tab-content">
        <h2>Compare Users Across All Systems</h2>
        <p style="color: #666; margin-bottom: 20px;">
            Query all available authentication sources and compare which users exist in each system.
        </p>

        <div class="button-group">
            <button class="btn-primary" id="compare-btn" onclick="handleCompare()">
                üöÄ Start Comparison
            </button>
        </div>

        <div id="comparison-results" style="display: none; margin-top: 40px;"></div>
    </div>

    <!-- Verify Specific Users Tab -->
    <div id="tab-content-verify" class="tab-content" style="display: none;">
        <h2 style="margin-bottom: 30px;">Upload User List for Verification</h2>

        <div class="form-group">
            <label for="csv-file">Select CSV File</label>
            <input type="file" id="csv-file" accept=".csv" />
            <small style="color: #666; margin-top: 5px; display: block;">
                Format: CSV with usernames in the first column (optional header)
            </small>
        </div>

        <div style="text-align: center; margin: 30px 0; color: #999;">
            ‚Äî or ‚Äî
        </div>

        <div class="form-group">
            <label for="remote-url">Fetch from Remote URL (Optional)</label>
            <input
                type="text"
                id="remote-url"
                placeholder="https://example.com/users.csv"
            />
            <small style="color: #666; margin-top: 5px; display: block;">
                Leave blank to use CSV file above
            </small>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="upload-btn" onclick="handleUpload()">
                Upload & Parse
            </button>
            <button class="btn-secondary" id="verify-btn" onclick="handleVerify()" disabled>
                Verify Users
            </button>
            <button class="btn-secondary" onclick="resetForm()">Reset</button>
        </div>

        <div id="users-list" style="display: none; margin-top: 30px;">
            <h3>Loaded Users</h3>
            <div
                id="users-container"
                style="
                    background: #f9f9f9;
                    padding: 15px;
                    border-radius: 4px;
                    max-height: 300px;
                    overflow-y: auto;
                    border: 1px solid #ddd;
                "
            ></div>
            <small id="user-count" style="display: block; margin-top: 10px; color: #666;"></small>
        </div>

        <div id="results-container" style="display: none; margin-top: 40px;"></div>
    </div>
</div>

<style>
    .tab-button.active {
        border-bottom-color: #667eea !important;
        color: #333 !important;
    }

    .comparison-grid {
        overflow-x: auto;
        margin: 20px 0;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .comparison-table th,
    .comparison-table td {
        padding: 12px;
        text-align: left;
        border: 1px solid #e0e0e0;
    }

    .comparison-table th {
        background: #f5f5f5;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .comparison-table tr:nth-child(even) {
        background: #fafafa;
    }

    .comparison-table tr:hover {
        background: #f0f7ff;
    }

    .user-cell {
        font-weight: 500;
        color: #333;
        min-width: 150px;
    }

    .user-link {
        color: #0066cc;
        text-decoration: none;
        transition: color 0.2s;
    }

    .user-link:hover {
        color: #004499;
        text-decoration: underline;
    }

    .found {
        color: #28a745;
        font-weight: bold;
        text-align: center;
    }

    .not-found {
        color: #dc3545;
        text-align: center;
    }

    .stats-box {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        opacity: 0.9;
    }

    .stat-card .number {
        font-size: 32px;
        font-weight: bold;
    }

    .stat-card.alt {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
</style>

<script>
    let currentUsers = [];
    let comparisonData = null;

    function switchTab(tabName) {
        // Hide all tabs
        document.getElementById("tab-content-compare").style.display = "none";
        document.getElementById("tab-content-verify").style.display = "none";

        // Remove active class from all buttons
        document.getElementById("tab-compare").classList.remove("active");
        document.getElementById("tab-verify").classList.remove("active");

        // Show selected tab
        document.getElementById("tab-content-" + tabName).style.display = "block";
        document.getElementById("tab-" + tabName).classList.add("active");

        // Save active tab to sessionStorage
        sessionStorage.setItem('activeTab', tabName);
    }

    function showAlert(message, type = "success") {
        const alertContainer = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.innerHTML = "";
        alertContainer.appendChild(alert);
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // ===== COMPARE ALL USERS =====

    async function handleCompare() {
        const compareBtn = document.getElementById("compare-btn");
        compareBtn.disabled = true;
        compareBtn.innerHTML = '<span class="loading"></span>Comparing...';

        try {
            const response = await fetch("/compare");

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "Comparison failed");
            }

            const data = await response.json();
            sessionStorage.setItem('comparisonData', JSON.stringify(data));
            displayComparison(data);
            showAlert("Comparison completed successfully", "success");
        } catch (error) {
            showAlert(`Error: ${error.message}`, "error");
        } finally {
            compareBtn.disabled = false;
            compareBtn.innerHTML = "üöÄ Start Comparison";
        }
    }

    function displayComparison(data) {
        comparisonData = data;
        const resultsContainer = document.getElementById("comparison-results");

        // Build stats
        let statsHtml =
            '<div class="stats-box">' +
            `<div class="stat-card"><h3>Total Users</h3><div class="number">${data.all_users.length}</div></div>`;

        data.sources.forEach((source) => {
            const count = data.source_counts[source];
            statsHtml += `<div class="stat-card alt"><h3>${source.toUpperCase()}</h3><div class="number">${count}</div></div>`;
        });

        statsHtml += "</div>";

        // Get unique roles for filter
        const uniqueRoles = [...new Set(Object.values(data.user_roles))].sort();

        // Build filter dropdown
        let filterHtml = '<div style="margin: 20px 0;">' +
            '<label for="role-filter" style="font-weight: 500; margin-right: 10px;">Filter by Role:</label>' +
            '<select id="role-filter" onchange="filterComparisonByRole()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; min-width: 200px;">' +
            '<option value="all">All Roles</option>';

        uniqueRoles.forEach(role => {
            filterHtml += `<option value="${role}">${role}</option>`;
        });

        filterHtml += '</select>' +
            '<span id="filtered-count" style="margin-left: 15px; color: #666;"></span>' +
            '</div>';

        // Build comparison table
        let tableHtml =
            '<h3>User Comparison Matrix</h3>' +
            '<p style="color: #666; margin-bottom: 15px;">‚úì = Account exists in system</p>' +
            filterHtml +
            '<div class="comparison-grid">' +
            '<table class="comparison-table">' +
            '<thead><tr><th>Username</th><th>Okta Role</th>';

        data.sources.forEach((source) => {
            tableHtml += `<th>${source}</th>`;
        });

        tableHtml += "</tr></thead><tbody id='comparison-tbody'>";

        data.all_users.forEach((user) => {
            const role = data.user_roles[user] || "n/a";
            tableHtml += `<tr data-role="${role}"><td class="user-cell"><a href="/user/${encodeURIComponent(user)}" class="user-link">${user}</a></td>`;
            tableHtml += `<td style="text-align: center;">${role}</td>`;

            data.sources.forEach((source) => {
                const exists = data.user_sources[user][source];
                const symbol = exists ? "‚úì" : "‚úó";
                const className = exists ? "found" : "not-found";
                tableHtml += `<td class="${className}">${symbol}</td>`;
            });

            tableHtml += "</tr>";
        });

        tableHtml +=
            "</tbody></table></div>" +
            '<small style="color: #666; display: block; margin-top: 15px;">Last updated: ' +
            new Date(data.timestamp).toLocaleString() +
            "</small>";

        resultsContainer.innerHTML = statsHtml + tableHtml;
        resultsContainer.style.display = "block";
        updateFilteredCount();
    }

    function filterComparisonByRole() {
        if (!comparisonData) return;

        const selectedRole = document.getElementById("role-filter").value;
        const rows = document.querySelectorAll("#comparison-tbody tr");

        // Save filter state
        sessionStorage.setItem('roleFilter', selectedRole);

        rows.forEach(row => {
            if (selectedRole === "all" || row.dataset.role === selectedRole) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        updateFilteredCount();
    }

    function updateFilteredCount() {
        const selectedRole = document.getElementById("role-filter")?.value;
        const totalRows = document.querySelectorAll("#comparison-tbody tr").length;
        const visibleRows = document.querySelectorAll("#comparison-tbody tr:not([style*='display: none'])").length;
        const countElement = document.getElementById("filtered-count");

        if (countElement && selectedRole !== "all") {
            countElement.textContent = `Showing ${visibleRows} of ${totalRows} users`;
        } else if (countElement) {
            countElement.textContent = "";
        }
    }

    // ===== VERIFY SPECIFIC USERS =====

    async function handleUpload() {
        const fileInput = document.getElementById("csv-file");
        const remoteUrl = document.getElementById("remote-url").value.trim();

        if (!fileInput.files.length && !remoteUrl) {
            showAlert("Please select a CSV file or provide a remote URL", "error");
            return;
        }

        const uploadBtn = document.getElementById("upload-btn");
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="loading"></span>Uploading...';

        try {
            let response;

            if (fileInput.files.length) {
                const formData = new FormData();
                formData.append("file", fileInput.files[0]);
                response = await fetch("/upload", {
                    method: "POST",
                    body: formData,
                });
            } else {
                showAlert(
                    "Remote fetch not yet implemented. Please upload a CSV file.",
                    "error"
                );
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = "Upload & Parse";
                return;
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "Upload failed");
            }

            const data = await response.json();
            currentUsers = data.users;
            sessionStorage.setItem('currentUsers', JSON.stringify(currentUsers));

            displayUsers(data.users);
            document.getElementById("verify-btn").disabled = false;
            showAlert(`Successfully loaded ${data.user_count} users`, "success");
        } catch (error) {
            showAlert(`Error: ${error.message}`, "error");
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = "Upload & Parse";
        }
    }

    function displayUsers(users) {
        const container = document.getElementById("users-container");
        const usersList = document.getElementById("users-list");
        const userCount = document.getElementById("user-count");

        container.innerHTML = users
            .map(
                (user) =>
                    `<div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0; font-size: 13px;">
            ${user}
        </div>`
            )
            .join("");

        userCount.textContent = `Total: ${users.length} users`;
        usersList.style.display = "block";
    }

    async function handleVerify() {
        if (!currentUsers.length) {
            showAlert("No users loaded. Please upload a CSV file first.", "error");
            return;
        }

        const verifyBtn = document.getElementById("verify-btn");
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<span class="loading"></span>Verifying...';

        try {
            const response = await fetch("/verify", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ users: currentUsers }),
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "Verification failed");
            }

            const data = await response.json();
            sessionStorage.setItem('verificationData', JSON.stringify(data));
            sessionStorage.setItem('currentUsers', JSON.stringify(currentUsers));
            displayResults(data);
            showAlert("Verification completed successfully", "success");
        } catch (error) {
            showAlert(`Error: ${error.message}`, "error");
        } finally {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = "Verify Users";
        }
    }

    function displayResults(data) {
        const resultsContainer = document.getElementById("results-container");

        // Build table
        let html = "<h3>Verification Results</h3>";
        html += '<table style="width: 100%; border-collapse: collapse;">';

        // Header row
        html += "<thead>";
        html += "<tr style='background: #f0f0f0; border-bottom: 2px solid #ddd;'>";
        html += '<th style="padding: 12px; text-align: left; font-weight: 500;">Username</th>';
        data.sources.forEach((source) => {
            html += `<th style="padding: 12px; text-align: center; font-weight: 500;">${source}</th>`;
        });
        html += "</tr>";
        html += "</thead>";

        // Data rows
        html += "<tbody>";
        data.users.forEach((user) => {
            html += `<tr style="border-bottom: 1px solid #e0e0e0;">`;
            html += `<td style="padding: 12px; font-weight: 500;"><a href="/user/${encodeURIComponent(user)}" class="user-link">${user}</a></td>`;
            data.sources.forEach((source) => {
                const exists = data.results[user][source];
                const symbol = exists ? "‚úì" : "‚úó";
                const color = exists ? "#28a745" : "#dc3545";
                html += `<td style="padding: 12px; text-align: center; color: ${color}; font-size: 18px; font-weight: bold;">${symbol}</td>`;
            });
            html += "</tr>";
        });
        html += "</tbody>";

        html += "</table>";

        html +=
            '<small style="display: block; margin-top: 15px; color: #666;">Last updated: ' +
            new Date(data.timestamp).toLocaleString() +
            "</small>";

        resultsContainer.innerHTML = html;
        resultsContainer.style.display = "block";
    }

    function resetForm() {
        document.getElementById("csv-file").value = "";
        document.getElementById("remote-url").value = "";
        document.getElementById("alert-container").innerHTML = "";
        document.getElementById("users-list").style.display = "none";
        document.getElementById("results-container").style.display = "none";
        document.getElementById("verify-btn").disabled = true;
        currentUsers = [];
    }

    // Restore cached data on page load
    function restoreCachedData() {
        // Restore active tab
        const activeTab = sessionStorage.getItem('activeTab');
        if (activeTab) {
            switchTab(activeTab);
        }

        // Restore comparison data
        const savedComparisonData = sessionStorage.getItem('comparisonData');
        if (savedComparisonData) {
            try {
                const data = JSON.parse(savedComparisonData);
                displayComparison(data);

                // Restore filter state
                const savedFilter = sessionStorage.getItem('roleFilter');
                if (savedFilter) {
                    const filterSelect = document.getElementById('role-filter');
                    if (filterSelect) {
                        filterSelect.value = savedFilter;
                        filterComparisonByRole();
                    }
                }
            } catch (e) {
                console.error('Failed to restore comparison data:', e);
            }
        }

        // Restore verification data
        const verificationData = sessionStorage.getItem('verificationData');
        const savedUsers = sessionStorage.getItem('currentUsers');
        if (verificationData && savedUsers) {
            try {
                const data = JSON.parse(verificationData);
                currentUsers = JSON.parse(savedUsers);
                displayResults(data);
                displayUsers(currentUsers);
                document.getElementById("verify-btn").disabled = false;
            } catch (e) {
                console.error('Failed to restore verification data:', e);
            }
        }
    }

    // Run on page load
    window.addEventListener('DOMContentLoaded', restoreCachedData);
</script>
{% endblock %}
